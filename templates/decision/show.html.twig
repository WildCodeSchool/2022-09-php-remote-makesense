{% extends 'base.html.twig' %}

{% block title %}Decision{% endblock %}

{% block body %}

    <div class="text-center">
        <h1 class="text-secondary">{{ decision.title }}</h1>
        <p> par {{ decision.user.firstName }} {{ decision.user.lastName }}</p>
    </div>


    <div class="container-fluid text-center p-5">
        <div class="row">
            <div class="col">
                <div class="accordion" id="accordionFlushExample">

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="panelsStayOpen-headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true" aria-controls="panelsStayOpen-collapseOne">
                                Les détails de la décision
                            </button>
                        </h2>
                        <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show" aria-labelledby="panelsStayOpen-headingOne">
                            <div class="accordion-body">
                                {{ decision.content }}
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="flush-headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
                                Objectifs
                            </button>
                        </h2>
                        <div id="flush-collapseTwo" class="accordion-collapse collapse" aria-labelledby="flush-headingTwo" data-bs-parent="#accordionFlushExample">
                            <div class="accordion-body">{{ decision.utility }}</div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="flush-headingThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseThree" aria-expanded="false" aria-controls="flush-collapseThree">
                                Contexte actuel
                            </button>
                        </h2>
                        <div id="flush-collapseThree" class="accordion-collapse collapse" aria-labelledby="flush-headingThree" data-bs-parent="#accordionFlushExample">
                            <div class="accordion-body">{{ decision.context }}</div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="flush-headingFour">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseFour" aria-expanded="false" aria-controls="flush-collapseFour">
                                Bénéfices
                            </button>
                        </h2>
                        <div id="flush-collapseFour" class="accordion-collapse collapse" aria-labelledby="flush-headingFour" data-bs-parent="#accordionFlushExample">
                            <div class="accordion-body">{{ decision.benefits }}</div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="flush-headingFive">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseFive" aria-expanded="false" aria-controls="flush-collapseFive">
                                Risques potentiels
                            </button>
                        </h2>
                        <div id="flush-collapseFive" class="accordion-collapse collapse" aria-labelledby="flush-headingFive" data-bs-parent="#accordionFlushExample">
                            <div class="accordion-body">{{ decision.inconvenients }}</div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="flush-headingSix">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#avis" aria-expanded="false" aria-controls="avis">
                                Avis
                                {% set number = 0 %}
                                {% for contribution in decision.contributions %}
                                    {% if  contribution.type == 'avis'  %}
                                        {% set number = number + 1 %}
                                    {% endif %}
                                {% endfor %}
                                ({{ number }})

                            </button>
                        </h2>
                        <div id="avis" class="accordion-collapse collapse" aria-labelledby="flush-headingSix" data-bs-parent="#accordionFlushExample">
                            <div class="accordion-body">

                                <ul>
                                    {% for contribution in decision.contributions %}
                                        {% if  contribution.type == 'avis'  %}
                                            <li>
                                                <h4>{{ contribution.contributor.employee.firstName }}
                                                    {{ contribution.contributor.employee.lastName }} -
                                                    avis donné le {{ contribution.date |date('d/m/Y') }}
                                                    en tant que personne {{ contribution.contributor.implication.name }}
                                                </h4>
                                                <p>{{ contribution.content }} </p>

                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="flush-headingSeven">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseSeven" aria-expanded="false" aria-controls="flush-collapseSeven">
                                Première décision prise
                            </button>
                        </h2>
                        <div id="flush-collapseSeven" class="accordion-collapse collapse" aria-labelledby="flush-headingSeven" data-bs-parent="#accordionFlushExample">
                            <div class="accordion-body">{{ decision.firstDecision }}</div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="flush-headingEight">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#conflits" aria-expanded="false" aria-controls="conflits">
                                Conflits
                                {% set number = 0 %}
                                {% for contribution in decision.contributions %}
                                    {% if  contribution.type == 'conflit'  %}
                                        {% set number = number + 1 %}
                                    {% endif %}
                                {% endfor %}
                                ({{ number }})

                            </button>
                        </h2>
                        <div id="conflits" class="accordion-collapse collapse" aria-labelledby="flush-headingEight" data-bs-parent="#accordionFlushExample">
                            <div class="accordion-body">

                                <ul>
                                    {% for contribution in decision.contributions %}
                                        {% if  contribution.type == 'conflit'  %}
                                            <li>
                                                <h4>{{ contribution.contributor.employee.firstName }}
                                                    {{ contribution.contributor.employee.lastName }} -
                                                    conflit exprimé le {{ contribution.date |date('d/m/Y') }}
                                                    en tant que personne {{ contribution.contributor.implication.name }}
                                                </h4>
                                                <p>{{ contribution.content }} </p>

                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="flush-headingNine">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                                Décision définitive
                            </button>
                        </h2>
                        <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlushExample">
                            <div class="accordion-body">{{ decision.definitiveDecision }}</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Timeline and contributors Area -->
            <div class="col-3">
                <section class="timeline_area">
                    <div class="container">
                        <h3>Dates à Retenir</h3>
                        <div class="row">
                            <div class="col-12">
                                <!-- Timeline Area-->
                                {% for timeline in decision.timelines %}
                                <div class="apland-timeline-area">
                                    <!-- Single Timeline Content-->
                                    <div class="single-timeline-area">
                                        <div class="timeline-date">
                                            <p>{{ timeline.endedAt |date('d/m/Y') }}</p>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="single-timeline-content d-flex ">

                                                    <div class="timeline-text">
                                                        <h6>{{timeline.name}}</h6>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Contributors Area-->

                   <div class="container mt-5">
                       <h3>Personnes Impactées</h3>
                       <div class="row mt-3">
                           <ul class="list-group list-group-horizontal m-0 p-0 m-auto justify-content-center">
                               {% for contributor in decision.contributors|filter(contributor => contributor.implication.name=="Impactée") %}
                               <li class="list-group-item"><img src ="https://picsum.photos/id/235/30/30" alt="{{ contributor.employee.firstName }} {{ contributor.employee.lastName }}" title="{{ contributor.employee.firstName }} {{ contributor.employee.lastName }}" class="rounded-circle"/></li>
                               {% endfor %}
                           </ul>
                       </div>
                   </div>

                    <div class="container mt-5">
                        <h3>Personnes Expertes</h3>
                        <div class="row mt-3">
                            <ul class="list-group list-group-horizontal m-0 p-0 m-auto justify-content-center">
                                {% for contributor in decision.contributors|filter(contributor => contributor.implication.name=="Experte") %}
                                    <li class="list-group-item"><img src ="https://picsum.photos/id/236/30/30" alt="{{ contributor.employee.firstName }} {{ contributor.employee.lastName }}" title="{{ contributor.employee.firstName }} {{ contributor.employee.lastName }}" class="rounded-circle"/></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                <!-- Buttons Area -->
                <div class="container mt-5">
                    {% if contributor %}
                    {% for timeline in decision.timelines %}
                        {% if timeline.name == 'Deadline pour donner son avis'
                            and "now" |date('Y-m-d') >= timeline.startedAt |date('Y-m-d')
                            and "now" |date('Y-m-d') <= timeline.endedAt |date('Y-m-d')  %}
                            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modal-avis"> Je donne mon avis</button>
                              <div class="container-fluid mt-4">
                                <div class="d-flex flex-row">
                                    {{ render(controller('App\\Controller\\ContributionController::newOpinion', {'decision': decision.id})) }}
                                </div>
                                </div>

                        {% endif %}
                        {% if timeline.name == 'Deadline pour entrer en conflit'
                            and "now" |date('Y-m-d') >= timeline.startedAt |date('Y-m-d')
                            and "now" |date('Y-m-d') <= timeline.endedAt |date('Y-m-d')  %}
                            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modal-conflict">J'entre en conflit</button>
                            <div class="container-fluid mt-4">
                                <div class="d-flex flex-row">
                                    {{ render(controller('App\\Controller\\ContributionController::newConflict', {'decision': decision.id})) }}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                    {% endif %}

                    {% if userDecision %}
                    {% for timeline in decision.timelines %}
                        {% if timeline.name == 'Première Décision Prise'
                            and "now" |date('Y-m-d') >= timeline.startedAt |date('Y-m-d')
                            and "now" |date('Y-m-d') <= timeline.endedAt |date('Y-m-d')  %}
                            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modal-first-decision"> Je prends ma première décision</button>
                            <div class="container-fluid mt-4">
                                <div class="d-flex flex-row">
                                    {{ render(controller('App\\Controller\\DecisionController::addFirstDecision', {'decision': decision.id})) }}
                                </div>
                            </div>
                        {% endif %}
                        {% if timeline.name == 'Decision définitive'
                            and "now" |date('Y-m-d') >= timeline.startedAt |date('Y-m-d')
                            and "now" |date('Y-m-d') <= timeline.endedAt |date('Y-m-d')  %}
                            <button type="button" class="btn btn-secondary">Je prends ma décision définitive</button>
                        {% endif %}
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
   </div>
    <div class="m-5">
        <a href="{{ path('app_decision_index') }}">back to list</a>

        <a href="{{ path('app_decision_edit', {'id': decision.id}) }}">edit</a>

        {{ include('decision/_delete_form.html.twig') }}
    </div>

        {% endblock %}
